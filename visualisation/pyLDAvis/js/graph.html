<!-- With credit to http://bl.ocks.org/eyaler/10586116 -->

<!DOCTYPE html>
<meta charset="utf-8">
<style>
body {
  overflow:hidden;
   margin:0;
}

text {
  font-family: sans-serif;
  pointer-events: none;
}

</style>
<body>
<script src="/d3.js"></script>
<script>

	var topic_name = "motif"
	var w = window.innerWidth;
	var h = window.innerHeight;
	var keyh = true;
	var focus_node = null,
	    highlight_node = null;
	var text_center = true;
	var outline = false;
	var min_score = 0;
	var max_score = 1;
	var highlight_color = "blue";
	var highlight_trans = 0.1;
	var default_node_color = "#ccc";
	var special_node_color = "#CC0000";
	//var default_node_color = "rgb(3,190,100)";
	var default_link_color = "#888";
	var nominal_base_node_size = 8;
	var nominal_text_size = 10;
	var max_text_size = 24;
	var nominal_stroke = 1.5;
	var max_stroke = 4.5;
	var max_base_node_size = 36;
	var min_zoom = 0.1;
	var max_zoom = 7;
	var svg = d3.select("body").append("svg");
	var zoom = d3.behavior.zoom().scaleExtent([min_zoom, max_zoom])
	var circle_opacity = 0.9
	
	var color = d3.scale.linear()
	    .domain([min_score, (min_score + max_score) / 2, max_score])
	    .range(["#1f77b4", "#2ca02c", "#ff7f0e"]);
	
	var size = d3.scale.pow().exponent(1)
	    .domain([1, 100])
	    .range([8, 24]);
	
	var force = d3.layout.force()
	    .linkDistance(60)
	    .charge(-300)
	    .size([w, h]);
	
	// Create a group for the graph plot
	var g = svg.append("g")
	    .attr("id", "vis-graph")
	    .attr("transform", "translate(267.1187199163185,285.8524262385378)scale(0.28677675605654135)")
	svg.style("cursor", "move");
	
	// global functions and variables to be called from parent window too
	var set_focus = undefined; 
	var set_highlight = undefined;	
	var exit_highlight = undefined;
	var graph_circle = undefined;
	var graph_link = undefined;
	var graph_nodes = undefined;
	var graph_linked_by_index = undefined;

	d3.json("/graph.json", function(error, graph) {

	    graph_nodes = graph.nodes; // to be used in parent window later
		
	    var linkedByIndex = {};
	    graph.links.forEach(function(d) {
	        linkedByIndex[d.source + "," + d.target] = true;
	    });
	    graph_linked_by_index = linkedByIndex;
	
	    function isConnected(a, b) {
	        return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
	    }
	
 	    function hasConnections(a) {
	        for (var property in linkedByIndex) {
	            s = property.split(",");
	            if ((s[0] == a.index || s[1] == a.index) && linkedByIndex[property])
	                return true;
	        }
	        return false;
	    }

 	    force.nodes(graph.nodes).links(graph.links).start();
	
	    var link = g.selectAll(".link")
	        .data(graph.links)
	        .enter().append("line")
	        .attr("class", "link")
	        .style("stroke-width", nominal_stroke)
	        .style("stroke", function(d) {
	            if (isNumber(d.score) && d.score >= 0) {
	            	return color(d.score);
	            } else {
	            	return default_link_color;
	            }
	        });
	    graph_link = link;

	    var node = g.selectAll(".node")
	        .data(graph.nodes)
	        .enter().append("g")
	        .attr("class", "node")
	        .call(force.drag)
	
	    node.on("dblclick.zoom", function(d) {
	        d3.event.stopPropagation();
	        var dcx = (window.innerWidth / 2 - d.x * zoom.scale());
	        var dcy = (window.innerHeight / 2 - d.y * zoom.scale());
	        zoom.translate([dcx, dcy]);
	        g.attr("transform", "translate(" + dcx + "," + dcy + ")scale(" + zoom.scale() + ")");
	    }); // end d3.json("graph.json", function(error, graph)
	
	    var tocolor = "fill";
	    var towhite = "stroke";
	    if (outline) {
	        tocolor = "stroke"
	        towhite = "fill"
	    }
	
	    var circle = node.append("path")
	        .attr("d", d3.svg.symbol()
	            .size(function(d) {
	                return Math.PI * Math.pow(size(d.size) || nominal_base_node_size, 2);
	            })
	            .type(function(d) {
	                return d.type;
	            }))
	        .style(tocolor, function(d) {
            	if (d.special == true) {
            		if (d.hasOwnProperty('highlight_colour')) {
            			return d.highlight_colour; // returns the user-defined highlight colour
            		} else {
                		return special_node_color; // returns the default colour for highlighted item
            		}
            	} else {
    	            if (isNumber(d.score) && d.score >= 0) return color(d.score);
    	            else {
    	            	return default_node_color;	            		
    	            }
            	}
	        })
	        //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })
	        .style("stroke-width", nominal_stroke)
	        .style(towhite, "white")
	        .style("opacity", circle_opacity);
		graph_circle = circle;
	    
	    var text = g.selectAll(".text")
	        .data(graph.nodes)
	        .enter().append("text")
	        .attr("dy", ".35em")
	        .style("font-size", function (d) { 
	        	if (d.name.indexOf(topic_name)>-1) {
		        	return max_text_size*2 + "px"	        		
	        	} else {
		        	return nominal_text_size + "px"	        		
	        	}
	        })
	        .attr("fill", function (d) {
	        	return "black"
	        })
	        .style("opacity", 0)
	
	    if (text_center) {
	        text.text(function(d) {
	                return d.name;
	            })
	            .style("text-anchor", "middle");
	    } else {
	        text.attr("dx", function(d) {
	                return (size(d.size) || nominal_base_node_size);
	            })
	            .text(function(d) {
	                return '\u2002' + d.name;
	            });
	    }
	
	    node
	        .on("mouseover", function(d) {
	            set_highlight(d);
	        })
	        .on("mousedown", function(d) {
	        	
	            d3.event.stopPropagation();
	            focus_node = d;
	            set_focus(d)
	            if (highlight_node === null) {
	            	set_highlight(d)
	            }

	            // highlight the topic in the main window too
	            tokens = d.name.split('_')
				node_type = tokens[0]
	            if (node_type.toLowerCase() === topic_name) {
	            
		            // select the topic in the main window
		            if (window.opener !== null) {
		            
			            vis_state = window.opener.vis_state	            
			            n = parseInt(tokens[1])
			            circles = vis_state['circles']
			            selected_circle = circles[0][n]
			            circle_id = selected_circle.id

			            parent_document = window.opener.document
			            
						// find the old topic
			            address_bar_val = window.location.search
			            function get(name){
			               if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
			                  return decodeURIComponent(name[1]);
			            }
						visID = get('visID')
		    			topicID = visID + "-topic";
					    docPrev = visID + "-prev";
					    docNext = visID + "-next";
						
					    // set as off if it's different from the current one
						old_topic = topicID + vis_state.topic
			            if (vis_state.topic > 0 && old_topic != circle_id) {
			            	var topic_off = window.opener.topic_off
			                topic_off(parent_document.getElementById(old_topic));
			            }

					    // set the currently selected topic and also enable the button to browse the MS1
			            parent_document.getElementById(topicID).value = vis_state.topic = n+1; 	// +1 because we index circles from 1,..
						parent_document.getElementById(topicID+"_shown").value = n;  				// but we show circle labels from 0,..
		                parent_document.getElementById(docPrev).setAttribute("style", "position: absolute; top: 490px; left: 985px; width: 80px; visibility: visible");
		                parent_document.getElementById(docNext).setAttribute("style", "position: absolute; top: 490px; left: 1070px; width: 80px; visibility: visible");
						topic_on = window.opener.topic_on
						topic_on(selected_circle, true);	            			            	
		            	
		            }	            	
	            }
	            	            
	        })
	        .on("mouseout", function(d) {
	            exit_highlight();
	        });
	
	    d3.select(window).on("mouseup", function() {
	        if (focus_node !== null) {
	            focus_node = null;
	            if (highlight_trans < 1) {
	                circle.style("opacity", circle_opacity);
	                // text.style("opacity", 1);
	                link.style("opacity", 1);
	            }
	        }
	        if (highlight_node === null) {
	        	exit_highlight();
	        }
	    });
	
	    exit_highlight = function() {
	        highlight_node = null;
	        if (focus_node === null) {
	            svg.style("cursor", "move");
	            if (highlight_color != "white") {
	                circle.style(towhite, "white");
	                text.style("font-weight", "normal");
			        text.style("font-size", function (d) { 
			        	if (d.name.indexOf(topic_name)>-1) {
				        	return max_text_size*2 + "px"	        		
			        	} else {
				        	return nominal_text_size + "px"	        		
			        	}
			        })
		        	text.style("opacity", 0);
	                link.style("stroke", function(o) {
	                    return (isNumber(o.score) && o.score >= 0) ? color(o.score) : default_link_color
	                });
	            }
	        }
	    }
	
	    set_focus = function(d) {
	        if (highlight_trans < 1) {
	            circle.style("opacity", function(o) {
	                return isConnected(d, o) ? 1 : highlight_trans;
	            });
	            text.style("opacity", function(o) {
	            	if (isConnected(d, o)) {
	            		if (o.name.indexOf(topic_name)>-1) {
		            		return 1;	            			
	            		} else {
		            		return 0.75;	            			
	            		}
	            	} else {
	            		return highlight_trans;
	            	}
	            });
	            link.style("opacity", function(o) {
	                return o.source.index == d.index || o.target.index == d.index ? 1 : highlight_trans;
	            });
	        }
	    }

	    set_highlight = function(d) {
	        svg.style("cursor", "pointer");
	        if (focus_node !== null) d = focus_node;
	        highlight_node = d;
	        if (highlight_color != "white") {
	            circle.style(towhite, function(o) {
	                return isConnected(d, o) ? highlight_color : "white";
	            });
	            text.style("font-weight", function(o) {
	                return isConnected(d, o) ? "bold" : "normal";
	            });
	        	if (d.name.indexOf(topic_name)==-1) { // only for document nodes
		            text.style("font-size", function(o) {
		            	if (d.name === o.name) {
				        	return nominal_text_size*4 + "px"	        		
		            	} else {
				        	if (o.name.indexOf(topic_name)>-1) {
				        		return max_text_size*2 + "px"
				        	} else {
					        	return nominal_text_size + "px"	        		
				        	}	            		
		            	}
		            });
	        	}
	            text.style("opacity", function(o) {
	            	if (isConnected(d, o)) {
	            		if (o.name.indexOf(topic_name)>-1) {
		            		return 1;	            			
	            		} else {
		            		return 0.75;	            			
	            		}
	            	} else {
	            		return highlight_trans;
	            	}
	            });
	            link.style("stroke", function(o) {
	                return o.source.index == d.index || o.target.index == d.index ? highlight_color : ((isNumber(o.score) && o.score >= 0) ? color(o.score) : default_link_color);
	            });
	        }
	    }
	
	    zoom.on("zoom", function() {
	
	        var stroke = nominal_stroke;
	        if (nominal_stroke * zoom.scale() > max_stroke) stroke = max_stroke / zoom.scale();
	        link.style("stroke-width", stroke);
	        circle.style("stroke-width", stroke);
	
	        var base_radius = nominal_base_node_size;
	        if (nominal_base_node_size * zoom.scale() > max_base_node_size) base_radius = max_base_node_size / zoom.scale();
	        circle.attr("d", d3.svg.symbol()
	            .size(function(d) {
	                return Math.PI * Math.pow(size(d.size) * base_radius / nominal_base_node_size || base_radius, 2);
	            })
	            .type(function(d) {
	                return d.type;
	            }))
	
	        //circle.attr("r", function(d) { return (size(d.size)*base_radius/nominal_base_node_size||base_radius); })
	        if (!text_center) text.attr("dx", function(d) {
	            return (size(d.size) * base_radius / nominal_base_node_size || base_radius);
	        });
	        
	        var text_size = nominal_text_size;
	        if (nominal_text_size * zoom.scale() > max_text_size) text_size = max_text_size / zoom.scale();
			text.style("font-size", function(d) {
	        	if (d.name.indexOf(topic_name)>-1) {
		        	return max_text_size*2 + "px"	        		
	        	} else {
		        	return text_size + "px"	        		
	        	}				
			});
	        
	        g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
	    });
	
	    svg.call(zoom);
	
	    resize();
	    //window.focus();
	    d3.select(window).on("resize", resize).on("keydown", keydown);
	
	    force.on("tick", function() {
	
	        node.attr("transform", function(d) {
	            return "translate(" + d.x + "," + d.y + ")";
	        });
	        text.attr("transform", function(d) {
	            return "translate(" + d.x + "," + d.y + ")";
	        });
	
	        link.attr("x1", function(d) {
	                return d.source.x;
	            })
	            .attr("y1", function(d) {
	                return d.source.y;
	            })
	            .attr("x2", function(d) {
	                return d.target.x;
	            })
	            .attr("y2", function(d) {
	                return d.target.y;
	            });
	
	        node.attr("cx", function(d) {
	                return d.x;
	            })
	            .attr("cy", function(d) {
	                return d.y;
	            });
	
	    });
	
	    function resize() {
	        var width = window.innerWidth,
	            height = window.innerHeight;
	        svg.attr("width", width).attr("height", height);
	        force.size([force.size()[0] + (width - w) / zoom.scale(), force.size()[1] + (height - h) / zoom.scale()]).resume();
	        w = width;
	        h = height;
	    }
	
	    function keydown() {
	        if (d3.event.keyCode == 32) {
	            force.stop();
	        } else if (d3.event.keyCode >= 48 && d3.event.keyCode <= 90 && !d3.event.ctrlKey && !d3.event.altKey && !d3.event.metaKey) {
	            switch (String.fromCharCode(d3.event.keyCode)) {
	                case "H":
	                    keyh = !keyh;
	                    break;
	            }
	            link.style("display", function(d) {
	                var flag = vis_by_type(d.source.special) && vis_by_type(d.target.special);
	                linkedByIndex[d.source.index + "," + d.target.index] = flag;
	                return flag ? "inline" : "none";
	            });
	            node.style("display", function(d) {
	                return vis_by_type_and_connection(d) ? "inline" : "none";
	            	// return (hasConnections(d)) && vis_by_type(d.special) ? "inline" : "none";
	            });
	            text.style("display", function(d) {
	                return vis_by_type_and_connection(d) ? "inline" : "none";
	            });
	            if (highlight_node !== null) {
	                if ((hasConnections(highlight_node)) && vis_by_type(highlight_node.special)) {
	                    if (focus_node !== null) set_focus(focus_node);
	                    set_highlight(highlight_node);
	                } else {
	                    exit_highlight();
	                }
	            }
	        }
	    }
	});
	
	function vis_by_type(special) {
		if (keyh) {
			return true;
		} else {
			return special;
		}
	}

	function vis_by_type_and_connection(d) {
		if (keyh) {
			return true;
		} else {
			if (d.special && (d.name.indexOf(topic_name)>-1)) {
				return true;
			} else {
				// check if we're connected to any special node that is a topic
		        for (var property in graph_linked_by_index) {
		            s = property.split(",");
		            var other_node = undefined;
		            // connection on the left side
		            if ((s[0] == d.index) && graph_linked_by_index[property]) {
		                other_node = graph_nodes[s[1]];		            	
		            }
		            // connection on the right side
		            if ((s[1] == d.index) && graph_linked_by_index[property]) {
		                other_node = graph_nodes[s[0]];		            	
		            }
		            // check other node is a special topic
		            if (other_node !== undefined && other_node.special && (other_node.name.indexOf(topic_name)>-1)) {
		            	return true;
		            }		            
		        }
		        return false;
			}
		}
	}
	
	function isNumber(n) {
	    return !isNaN(parseFloat(n)) && isFinite(n);
	}
	
</script>